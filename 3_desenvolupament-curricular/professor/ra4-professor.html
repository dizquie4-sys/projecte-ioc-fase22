<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RA4 ¬∑ Professor ¬∑ Avaluaci√≥ autom√†tica</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js"></script>
    <style>
        /* ESTILS COMPLETS (exactament igual que els RA) */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Arial, sans-serif;
        }
        body {
            background: linear-gradient(135deg, #f5f5f5 0%, #e9ecef 100%);
            padding: 30px;
            color: #212529;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(209,34,43,0.15);
            overflow: hidden;
        }
        .header {
            background: #D1222B;
            padding: 25px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        .header h1 {
            font-size: 2rem;
            margin-bottom: 5px;
        }
        .header .accessibility-icon {
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            color: white;
            border: 2px solid white;
        }
        .content {
            padding: 30px 35px;
        }
        .badge-groc {
            background: #FFC72C;
            color: #1e293b;
            padding: 8px 18px;
            border-radius: 40px;
            font-weight: 700;
            font-size: 1rem;
            display: inline-block;
            margin-bottom: 20px;
            border: 2px solid #D1222B;
        }
        .section-title {
            font-size: 1.8rem;
            color: #D1222B;
            border-left: 8px solid #FFC72C;
            padding-left: 18px;
            margin: 30px 0 20px;
        }
        .btn {
            background: white;
            border: 2px solid #D1222B;
            color: #D1222B;
            padding: 10px 20px;
            border-radius: 40px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin: 5px;
            transition: all 0.2s;
            text-decoration: none;
        }
        .btn:hover, .btn:focus {
            background: #D1222B;
            color: white;
            outline: 3px solid #FFC72C;
        }
        .btn-primary {
            background: #D1222B;
            color: white;
        }
        .btn-primary:hover, .btn-primary:focus {
            background: #b01e25;
            border-color: #b01e25;
        }
        .btn-danger {
            background: #6c757d;
            color: white;
            border: none;
        }
        .btn-success {
            background: #28a745;
            color: white;
            border: none;
        }
        .btn-excel {
            background: #1e88e5;
            color: white;
            border: none;
        }
        .btn-pdf {
            background: #dc3545;
            color: white;
            border: none;
        }
        .btn-dalt {
            background: #FFC72C;
            color: #D1222B;
            border: none;
            font-weight: bold;
        }
        .btn-dalt:hover {
            background: #D1222B;
            color: white;
        }
        .buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 20px 0;
            justify-content: center;
        }
        .import-area {
            background: #f0f7ff;
            border-radius: 20px;
            padding: 20px;
            margin: 20px 0;
            border: 2px solid #D1222B;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 0.9rem;
        }
        th {
            background: #D1222B;
            color: white;
            padding: 10px;
        }
        td {
            border: 1px solid #ffd9d9;
            padding: 8px;
        }
        tr:hover {
            background: #fff3cd;
        }
        .valoracio-box {
            background: #e6f2ff;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            border: 2px solid #D1222B;
        }
        textarea, input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ffd9d9;
            border-radius: 12px;
            margin: 8px 0 15px;
            font-size: 1rem;
        }
        textarea:focus, input:focus, select:focus {
            outline: 3px solid #FFC72C;
            border-color: #D1222B;
        }
        .footer {
            background: #f1f5f9;
            padding: 20px;
            text-align: center;
        }
        hr {
            border: 2px dashed #FFC72C;
            margin: 30px 0;
        }
        .enllac-normativa {
            display: inline-block;
            background: #f0f7ff;
            border: 1px solid #D1222B;
            border-radius: 20px;
            padding: 5px 15px;
            margin: 5px;
            color: #D1222B;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.2s;
        }
        .enllac-normativa:hover {
            background: #D1222B;
            color: white;
        }
        .info-links {
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 1px solid #e9ecef;
        }
        .rubrica-visual {
            background: #f8fafc;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            border: 2px solid #FFC72C;
        }
        .rubrica-visual table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        .rubrica-visual th {
            background: #D1222B;
            color: white;
            padding: 10px;
            font-size: 0.9rem;
        }
        .rubrica-visual td {
            border: 1px solid #ffd9d9;
            padding: 8px;
            font-size: 0.85rem;
        }
        
        /* PANEL DE RESPOSTES DESPLEGABLE */
        .panel-respostes {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 10px 0;
            border: 2px solid #D1222B;
            max-height: 400px;
            overflow-y: auto;
            display: none;
        }
        
        /* BOT√ì FLOTANT PER TORNAR A DALT */
        .btn-flotant {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 99;
            border-radius: 50px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>
    <!-- BOT√ì FLOTANT PER TORNAR A DALT -->
    <button class="btn btn-dalt btn-flotant" id="tornarDaltBtn" title="Tornar a dalt">
        ‚¨ÜÔ∏è Dalt
    </button>

    <div class="container">
        <div class="header">
            <div>
                <h1>‚ö° RA4 ¬∑ Professor ¬∑ Avaluaci√≥ autom√†tica</h1>
                <p>El meu perfil professional ¬∑ DAFO + Full de ruta</p>
            </div>
            <div class="accessibility-icon">‚ôø</div>
        </div>
        <div class="content">
            <div class="badge-groc">üìå Corrector autom√†tic per al RA4</div>

            <!-- ENLLA√áOS D'INTER√àS (conservats del RA4) -->
            <div class="info-links">
                <p><strong>üìö Enlla√ßos d'inter√®s per a la correcci√≥:</strong></p>
                <div>
                    <a href="https://dizquie4-sys.github.io/CURSO-CDD/fp-trs-ipo-i-u4-pdfindex.pdf" target="_blank" class="enllac-normativa">üìñ Llibre: Orientaci√≥ professional (IOC)</a>
                    <a href="https://europass.europa.eu/es/create-europass-cv" target="_blank" class="enllac-normativa">Crear CV Europass</a>
                    <a href="https://serveiocupacio.gencat.cat/ca/inici/" target="_blank" class="enllac-normativa">SOC - Servei d'Ocupaci√≥</a>
                </div>
            </div>

            <!-- IMPORTADOR JSON -->
            <div class="import-area">
                <h2 style="color:#D1222B;">üì• Importar JSON dels alumnes (RA4)</h2>
                <p>Selecciona els fitxers JSON que han enviat els alumnes.</p>
                <input type="file" id="jsonFiles" multiple accept=".json" style="padding:10px; border:2px dashed #D1222B; width:100%;">
                <div class="buttons">
                    <button class="btn btn-primary" id="carregarJsonBtn">üìÇ Carregar fitxers</button>
                    <button class="btn btn-danger" id="netejarBtn">üóëÔ∏è Netejar tot</button>
                </div>
                <div id="statusMessage" style="margin-top:15px; padding:10px; border-radius:10px; display:none;"></div>
            </div>

            <!-- TAULA DE RESULTATS -->
            <div id="taulaContainer" style="display:none;">
                <h2 class="section-title">üìä Resultats del grup (RA4)</h2>
                <div style="overflow-x: auto;">
                    <table id="resultatsTaula">
                        <thead>
                            <tr>
                                <th>Nom</th>
                                <th>Grup</th>
                                <th>Autodiagnosi</th>
                                <th>Full ruta</th>
                                <th>Reflexi√≥</th>
                                <th>Qualitat</th>
                                <th>Nota final</th>
                                <th>PDF</th>
                            </tr>
                        </thead>
                        <tbody id="taulaBody"></tbody>
                    </table>
                </div>

                <!-- R√öBRICA VISIBLE (PER CONSULTA) -->
                <div class="rubrica-visual">
                    <h3 style="color:#D1222B; margin-bottom:15px;">üìä R√öBRICA D'AVALUACI√ì RA4</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Criteri</th>
                                <th>Pes</th>
                                <th>1 - No assolit</th>
                                <th>2 - En proc√©s</th>
                                <th>3 - Assolit</th>
                                <th>4 - Excel¬∑lent</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>Autodiagnosi (DAFO)</strong></td>
                                <td>40%</td>
                                <td>No identifica o errors greus</td>
                                <td>Identifica 2-3 elements</td>
                                <td>Identifica els 4 amb an√†lisi b√†sica</td>
                                <td>An√†lisi completa i ben fonamentada</td>
                            </tr>
                            <tr>
                                <td><strong>Full de ruta</strong></td>
                                <td>30%</td>
                                <td>Objectius poc clars o irreals</td>
                                <td>Objectius b√†sics sense planificaci√≥</td>
                                <td>3 objectius amb accions i terminis</td>
                                <td>Objectius amb accions, terminis i recursos</td>
                            </tr>
                            <tr>
                                <td><strong>Reflexi√≥</strong></td>
                                <td>20%</td>
                                <td>No connecta DAFO amb full de ruta</td>
                                <td>Connexi√≥ superficial</td>
                                <td>Connexi√≥ clara</td>
                                <td>Reflexi√≥ profunda i visi√≥ de futur</td>
                            </tr>
                            <tr>
                                <td><strong>Qualitat formal</strong></td>
                                <td>10%</td>
                                <td>Incomplet o inintel¬∑ligible</td>
                                <td>Conf√∫s o errors significatius</td>
                                <td>Clar i organitzat</td>
                                <td>Professional, ben estructurat</td>
                            </tr>
                        </tbody>
                    </table>
                    <p style="margin-top:10px; font-style:italic; color:#D1222B;">* Els valors autom√†tics s√≥n orientatius. Pots modificar-los manualment.</p>
                </div>

                <!-- SELECCI√ì D'ALUMNE PER VALORAR -->
                <div class="valoracio-box">
                    <h3 style="color:#D1222B;">üìù Avaluaci√≥ individual (RA4)</h3>
                    <select id="selectorAlumne" style="width:100%; padding:10px; margin:10px 0;">
                        <option value="">-- Selecciona un alumne --</option>
                    </select>
                    
                    <!-- BOT√ì PER MOSTRAR/AMAGAR RESPOSTES -->
                    <div style="text-align: center; margin: 10px 0;">
                        <button class="btn btn-primary" id="toggleRespostesBtn">
                            üìã Mostrar/amagar respostes completes
                        </button>
                    </div>
                    
                    <!-- PANEL DE RESPOSTES DESPLEGABLE -->
                    <div id="panelRespostes" class="panel-respostes">
                        <h4 style="color:#D1222B; margin-bottom:10px;">Respostes de l'alumne</h4>
                        <div id="contingutRespostes">
                            Selecciona un alumne i fes clic a "Mostrar respostes".
                        </div>
                    </div>
                    
                    <h4 style="color:#D1222B;">R√∫brica RA4 (punts 1-4)</h4>
                    
                    <label><strong>Autodiagnosi (DAFO) (40%):</strong></label>
                    <input type="number" id="notaAutodiagnosi" min="1" max="4" step="1" value="3">
                    
                    <label><strong>Full de ruta (30%):</strong></label>
                    <input type="number" id="notaFullRuta" min="1" max="4" step="1" value="3">
                    
                    <label><strong>Reflexi√≥ (20%):</strong></label>
                    <input type="number" id="notaReflexio" min="1" max="4" step="1" value="3">
                    
                    <label><strong>Qualitat formal (10%):</strong></label>
                    <input type="number" id="notaQualitat" min="1" max="4" step="1" value="3">
                    
                    <label><strong>Punts forts observats:</strong></label>
                    <textarea id="puntsForts" rows="3"></textarea>
                    
                    <label><strong>Aspectes a millorar:</strong></label>
                    <textarea id="aspectesMillora" rows="3"></textarea>
                    
                    <label><strong>Recomanaci√≥ professional:</strong></label>
                    <textarea id="recomanacio" rows="2"></textarea>
                    
                    <label><strong>Valoraci√≥ qualitativa global:</strong></label>
                    <textarea id="valoracioGlobal" rows="4"></textarea>
                    
                    <div class="buttons">
                        <button class="btn btn-primary" id="guardarAvaluacioBtn">üíæ Guardar avaluaci√≥</button>
                        <button class="btn btn-pdf" id="generarPdfIndividualBtn">üì• Generar PDF individual</button>
                    </div>
                </div>

                <!-- BOTONS GENERALS -->
                <div class="buttons">
                    <button class="btn btn-excel" id="excelBtn">üì• Exportar a Excel</button>
                    <button class="btn btn-pdf" id="pdfTotsBtn">üì• Generar PDFs de tots</button>
                </div>
            </div>

            <hr>
            <p style="text-align:center; color:#6c757d;">Eina de correcci√≥ per al professorat ¬∑ RA4 ¬∑ Les dades no es guarden al servidor</p>
        </div>
        <div class="footer">Diego Izquierdo ¬∑ FOL ¬∑ IOC ¬∑ Avaluaci√≥ RA4 ‚ôø</div>
    </div>

    <script>
        let alumnes = [];
        let alumnesAvaluats = {};

        // ===========================================
        // FUNCI√ì PER OBTENIR NIVELL (1-4) A TEXT
        // ===========================================
        function getNivellText(valor) {
            const nivells = ['No assolit', 'En proc√©s', 'Assolit', 'Excel¬∑lent'];
            return nivells[valor - 1] || 'No assolit';
        }

        // ===========================================
        // FUNCI√ì PER CALCULAR NOTA FINAL (sobre 10)
        // ===========================================
        function calcularNotaFinal(autodiagnosi, fullRuta, reflexio, qualitat) {
            let nota = (autodiagnosi * 0.4 + fullRuta * 0.3 + reflexio * 0.2 + qualitat * 0.1) * 2.5;
            return nota.toFixed(2);
        }

        // ===========================================
        // FUNCIONS PER GENERAR CONTINGUT AUTOM√ÄTIC
        // ===========================================
        function generarPuntsFortsAuto(alumne) {
            let punts = [];
            
            // Comprovar DAFO (4 camps)
            if (alumne.debilitats && alumne.amenaces && alumne.fortaleses && alumne.oportunitats) {
                if (alumne.debilitats.length > 20 && alumne.amenaces.length > 20 && 
                    alumne.fortaleses.length > 20 && alumne.oportunitats.length > 20) {
                    punts.push('RA4: DAFO complet amb els quatre quadrants ben desenvolupats.');
                }
            }
            
            // Comprovar full de ruta (3 objectius)
            if (alumne.objectiu1 && alumne.accions1 && alumne.termini1 && alumne.recursos1) {
                punts.push('RA4: Full de ruta amb objectius ben definits.');
            }
            
            // Comprovar reflexi√≥
            if (alumne.reflexio && alumne.reflexio.length > 100) {
                punts.push('RA4: Bona reflexi√≥ que connecta el DAFO amb el full de ruta.');
            }
            
            if (punts.length === 0) punts.push('Treball correcte en general.');
            return punts.join('\n');
        }

        function generarAspectesMilloraAuto(alumne) {
            let millores = [];
            
            // Comprovar DAFO
            if (!alumne.debilitats || alumne.debilitats.length < 20) 
                millores.push('RA4: Cal aprofundir en l\'an√†lisi de debilitats.');
            if (!alumne.amenaces || alumne.amenaces.length < 20) 
                millores.push('RA4: Cal aprofundir en l\'an√†lisi d\'amenaces.');
            if (!alumne.fortaleses || alumne.fortaleses.length < 20) 
                millores.push('RA4: Cal aprofundir en l\'an√†lisi de fortaleses.');
            if (!alumne.oportunitats || alumne.oportunitats.length < 20) 
                millores.push('RA4: Cal aprofundir en l\'an√†lisi d\'oportunitats.');
            
            // Comprovar full de ruta
            if (!alumne.objectiu1 || !alumne.accions1 || !alumne.termini1 || !alumne.recursos1) 
                millores.push('RA4: El full de ruta est√† incomplet. Cal definir els 3 objectius amb accions, terminis i recursos.');
            
            // Comprovar reflexi√≥
            if (!alumne.reflexio || alumne.reflexio.length < 50) 
                millores.push('RA4: La reflexi√≥ √©s massa breu. Cal connectar el DAFO amb els objectius.');
            
            if (millores.length === 0) millores.push('Treball complet, felicitats!');
            return millores.join('\n');
        }

        function generarRecomanacioAuto(alumne, nota) {
            if (nota >= 8) {
                return 'Excel¬∑lent treball. Continua aprofundint en el teu desenvolupament professional.';
            } else if (nota >= 6) {
                return 'Bona feina. Revisa els aspectes a millorar per assolir l\'excel¬∑l√®ncia en el teu full de ruta.';
            } else {
                return 'Treball suficient. Es recomana revisar els continguts b√†sics del RA4 i la metodologia DAFO.';
            }
        }

        function generarValoracioGlobalAuto(alumne, nota, nom) {
            if (nota >= 8) {
                return `${nom}, el teu treball demostra una comprensi√≥ excel¬∑lent de l'autodiagnosi i la planificaci√≥ professional. Has identificat amb precisi√≥ les teves fortaleses i febleses, i has dissenyat un full de ruta realista i ben fonamentat. La reflexi√≥ final connecta perfectament el DAFO amb els objectius. En conjunt, has fet una molt bona feina. Felicitats!`;
            } else if (nota >= 6) {
                return `${nom}, el teu treball demostra una comprensi√≥ s√≤lida de l'autodiagnosi i la planificaci√≥ professional. Has identificat els elements principals i has definit objectius coherents. Amb una mica m√©s de detall en els recursos i terminis, assolir√†s l'excel¬∑l√®ncia. Bona feina!`;
            } else {
                return `${nom}, el teu treball demostra una comprensi√≥ b√†sica de l'autodiagnosi i la planificaci√≥ professional. Cal revisar els continguts fonamentals del RA4 i aprofundir en l'an√†lisi DAFO i la definici√≥ d'objectius. Amb m√©s dedicaci√≥, podr√†s millorar. √Änims!`;
            }
        }

        // ===========================================
        // PROCESSAR JSON (adaptat al RA4)
        // ===========================================
        function processarJSON(file, callback) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    alumnes.push({
                        nom: data.nom || 'Sense nom',
                        grup: data.grup || 'Sense grup',
                        // DAFO
                        debilitats: data.debilitats || '',
                        amenaces: data.amenaces || '',
                        fortaleses: data.fortaleses || '',
                        oportunitats: data.oportunitats || '',
                        // Full de ruta (3 objectius)
                        objectiu1: data.objectiu1 || '',
                        accions1: data.accions1 || '',
                        termini1: data.termini1 || '',
                        recursos1: data.recursos1 || '',
                        objectiu2: data.objectiu2 || '',
                        accions2: data.accions2 || '',
                        termini2: data.termini2 || '',
                        recursos2: data.recursos2 || '',
                        objectiu3: data.objectiu3 || '',
                        accions3: data.accions3 || '',
                        termini3: data.termini3 || '',
                        recursos3: data.recursos3 || '',
                        // Reflexi√≥
                        reflexio: data.reflexio || '',
                        // Notes (pendents)
                        notaAutodiagnosi: 'pendent',
                        notaFullRuta: 'pendent',
                        notaReflexio: 'pendent',
                        notaQualitat: 'pendent',
                        notaFinal: 'pendent',
                        data: data.data || new Date().toISOString()
                    });
                    
                    callback(null);
                } catch (error) {
                    callback('Error: ' + error);
                }
            };
            reader.readAsText(file);
        }

        // ===========================================
        // ORDENAR PER COGNOM
        // ===========================================
        function getCognom(nomComplet) {
            let parts = nomComplet.trim().split(' ');
            return parts[parts.length - 1];
        }

        // ===========================================
        // ACTUALITZAR TAULA
        // ===========================================
        function actualitzarTaula() {
            // Ordenar per cognom
            alumnes.sort((a, b) => {
                let cognomA = getCognom(a.nom);
                let cognomB = getCognom(b.nom);
                return cognomA.localeCompare(cognomB, 'ca');
            });

            let tbody = document.getElementById('taulaBody');
            let selector = document.getElementById('selectorAlumne');
            tbody.innerHTML = '';
            selector.innerHTML = '<option value="">-- Selecciona un alumne --</option>';
            
            alumnes.forEach((a, index) => {
                let notaFinal = a.notaFinal === 'pendent' ? 'pendent' : a.notaFinal;
                
                let row = `<tr>
                    <td>${a.nom}</td>
                    <td>${a.grup}</td>
                    <td>${a.notaAutodiagnosi}</td>
                    <td>${a.notaFullRuta}</td>
                    <td>${a.notaReflexio}</td>
                    <td>${a.notaQualitat}</td>
                    <td><strong>${notaFinal}</strong></td>
                    <td><button class="btn btn-pdf" onclick="generarPdfIndividual(${index})">üìÑ</button></td>
                </tr>`;
                tbody.innerHTML += row;
                
                selector.innerHTML += `<option value="${index}">${a.nom} (${a.grup})</option>`;
            });
            
            document.getElementById('taulaContainer').style.display = 'block';
        }

        // ===========================================
        // TORNAR A DALT (SUAU)
        // ===========================================
        document.getElementById('tornarDaltBtn').addEventListener('click', function() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        });

        // ===========================================
        // PANEL DE RESPOSTES DESPLEGABLE
        // ===========================================
        document.getElementById('toggleRespostesBtn').addEventListener('click', function() {
            let panel = document.getElementById('panelRespostes');
            let contingut = document.getElementById('contingutRespostes');
            let index = document.getElementById('selectorAlumne').value;
            
            if (index === '') {
                alert('Selecciona un alumne primer');
                return;
            }
            
            let alumne = alumnes[index];
            
            if (panel.style.display === 'none' || panel.style.display === '') {
                // Mostrar panel amb les respostes
                let respostesHTML = `
                    <p><strong>DAFO:</strong></p>
                    <p><strong>Debilitats:</strong> ${alumne.debilitats || '(sense resposta)'}</p>
                    <p><strong>Amenaces:</strong> ${alumne.amenaces || '(sense resposta)'}</p>
                    <p><strong>Fortaleses:</strong> ${alumne.fortaleses || '(sense resposta)'}</p>
                    <p><strong>Oportunitats:</strong> ${alumne.oportunitats || '(sense resposta)'}</p>
                    <p><strong>Full de ruta:</strong></p>
                    <p><strong>Objectiu 1:</strong> ${alumne.objectiu1 || ''} - Accions: ${alumne.accions1 || ''} - Termini: ${alumne.termini1 || ''} - Recursos: ${alumne.recursos1 || ''}</p>
                    <p><strong>Objectiu 2:</strong> ${alumne.objectiu2 || ''} - Accions: ${alumne.accions2 || ''} - Termini: ${alumne.termini2 || ''} - Recursos: ${alumne.recursos2 || ''}</p>
                    <p><strong>Objectiu 3:</strong> ${alumne.objectiu3 || ''} - Accions: ${alumne.accions3 || ''} - Termini: ${alumne.termini3 || ''} - Recursos: ${alumne.recursos3 || ''}</p>
                    <p><strong>Reflexi√≥:</strong> ${alumne.reflexio || '(sense resposta)'}</p>
                `;
                
                contingut.innerHTML = respostesHTML;
                panel.style.display = 'block';
            } else {
                // Amagar panel
                panel.style.display = 'none';
            }
        });

        // ===========================================
        // SELECCIONAR ALUMNE
        // ===========================================
        document.getElementById('selectorAlumne').addEventListener('change', function() {
            let index = this.value;
            if (index === '') {
                document.getElementById('notaAutodiagnosi').value = '3';
                document.getElementById('notaFullRuta').value = '3';
                document.getElementById('notaReflexio').value = '3';
                document.getElementById('notaQualitat').value = '3';
                document.getElementById('puntsForts').value = '';
                document.getElementById('aspectesMillora').value = '';
                document.getElementById('recomanacio').value = '';
                document.getElementById('valoracioGlobal').value = '';
                
                // Amagar panel si estava obert
                document.getElementById('panelRespostes').style.display = 'none';
                return;
            }
            
            let alumne = alumnes[index];
            
            if (alumnesAvaluats[index]) {
                let av = alumnesAvaluats[index];
                document.getElementById('notaAutodiagnosi').value = av.autodiagnosi;
                document.getElementById('notaFullRuta').value = av.fullRuta;
                document.getElementById('notaReflexio').value = av.reflexio;
                document.getElementById('notaQualitat').value = av.qualitat;
                document.getElementById('puntsForts').value = av.puntsForts || '';
                document.getElementById('aspectesMillora').value = av.aspectesMillora || '';
                document.getElementById('recomanacio').value = av.recomanacio || '';
                document.getElementById('valoracioGlobal').value = av.valoracioGlobal || '';
            } else {
                document.getElementById('notaAutodiagnosi').value = '3';
                document.getElementById('notaFullRuta').value = '3';
                document.getElementById('notaReflexio').value = '3';
                document.getElementById('notaQualitat').value = '3';
                
                let notaTemp = calcularNotaFinal(3, 3, 3, 3);
                document.getElementById('puntsForts').value = generarPuntsFortsAuto(alumne);
                document.getElementById('aspectesMillora').value = generarAspectesMilloraAuto(alumne);
                document.getElementById('recomanacio').value = generarRecomanacioAuto(alumne, notaTemp);
                document.getElementById('valoracioGlobal').value = generarValoracioGlobalAuto(alumne, notaTemp, alumne.nom.split(' ')[0]);
            }
        });

        // ===========================================
        // GUARDAR AVALUACI√ì
        // ===========================================
        document.getElementById('guardarAvaluacioBtn').addEventListener('click', function() {
            let index = document.getElementById('selectorAlumne').value;
            if (index === '') {
                alert('Selecciona un alumne');
                return;
            }
            
            let autodiagnosi = parseInt(document.getElementById('notaAutodiagnosi').value);
            let fullRuta = parseInt(document.getElementById('notaFullRuta').value);
            let reflexio = parseInt(document.getElementById('notaReflexio').value);
            let qualitat = parseInt(document.getElementById('notaQualitat').value);
            let notaFinal = calcularNotaFinal(autodiagnosi, fullRuta, reflexio, qualitat);
            
            alumnesAvaluats[index] = {
                autodiagnosi: autodiagnosi,
                fullRuta: fullRuta,
                reflexio: reflexio,
                qualitat: qualitat,
                puntsForts: document.getElementById('puntsForts').value,
                aspectesMillora: document.getElementById('aspectesMillora').value,
                recomanacio: document.getElementById('recomanacio').value,
                valoracioGlobal: document.getElementById('valoracioGlobal').value,
                notaFinal: notaFinal
            };
            
            alumnes[index].notaAutodiagnosi = autodiagnosi + '/4 - ' + getNivellText(autodiagnosi);
            alumnes[index].notaFullRuta = fullRuta + '/4 - ' + getNivellText(fullRuta);
            alumnes[index].notaReflexio = reflexio + '/4 - ' + getNivellText(reflexio);
            alumnes[index].notaQualitat = qualitat + '/4 - ' + getNivellText(qualitat);
            alumnes[index].notaFinal = notaFinal;
            
            actualitzarTaula();
            alert('Avaluaci√≥ guardada correctament');
        });

        // ===========================================
        // GENERAR PDF INDIVIDUAL
        // ===========================================
        function generarPdfIndividual(index) {
            let alumne = alumnes[index];
            let avaluacio = alumnesAvaluats[index] || {
                autodiagnosi: 3,
                fullRuta: 3,
                reflexio: 3,
                qualitat: 3,
                puntsForts: generarPuntsFortsAuto(alumne),
                aspectesMillora: generarAspectesMilloraAuto(alumne),
                recomanacio: generarRecomanacioAuto(alumne, 7.5),
                valoracioGlobal: generarValoracioGlobalAuto(alumne, 7.5, alumne.nom.split(' ')[0]),
                notaFinal: calcularNotaFinal(3, 3, 3, 3)
            };
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(16);
            doc.setTextColor(0, 0, 0);
            doc.text('INFORME D\'AVALUACI√ì - RA4', 20, 20);
            
            doc.setFontSize(10);
            doc.text('Microactivitat: El meu perfil professional (DAFO + Full de ruta)', 20, 30);
            doc.text('Professor: Diego Izquierdo Per√°n', 20, 37);
            doc.text('Data: ' + new Date().toLocaleDateString('ca-ES'), 20, 44);
            
            doc.text('DADES DE L\'ESTUDIANT', 20, 59);
            doc.text('Nom: ' + alumne.nom, 20, 66);
            doc.text('Grup: ' + alumne.grup, 20, 73);
            
            doc.text('R√öBRICA D\'AVALUACI√ì', 20, 88);
            doc.text('1. Autodiagnosi (DAFO): ' + avaluacio.autodiagnosi + '/4 - Nivell: ' + getNivellText(avaluacio.autodiagnosi), 25, 98);
            doc.text('2. Full de ruta: ' + avaluacio.fullRuta + '/4 - Nivell: ' + getNivellText(avaluacio.fullRuta), 25, 105);
            doc.text('3. Reflexi√≥: ' + avaluacio.reflexio + '/4 - Nivell: ' + getNivellText(avaluacio.reflexio), 25, 112);
            doc.text('4. Qualitat formal: ' + avaluacio.qualitat + '/4 - Nivell: ' + getNivellText(avaluacio.qualitat), 25, 119);
            
            doc.text('RESULTATS FINALS', 20, 134);
            doc.text('PUNTUACI√ì TOTAL: ' + (avaluacio.autodiagnosi + avaluacio.fullRuta + avaluacio.reflexio + avaluacio.qualitat) + '/16', 20, 144);
            doc.text('EQUIVAL√àNCIA: ' + avaluacio.notaFinal + '/10', 20, 151);
            
            let nivellGlobal = parseFloat(avaluacio.notaFinal) >= 8 ? 'Excel¬∑lent' : 
                              parseFloat(avaluacio.notaFinal) >= 6 ? 'Assolit' : 'En proc√©s';
            doc.text('NIVELL: ' + nivellGlobal, 20, 158);
            
            doc.text('FEEDBACK PERSONALITZAT', 20, 173);
            let y = 183;
            
            doc.text('Punts forts:', 20, y);
            y += 7;
            let puntsLines = doc.splitTextToSize(avaluacio.puntsForts || 'No especificat', 170);
            doc.text(puntsLines, 20, y);
            y += puntsLines.length * 5 + 10;
            
            doc.text('Aspectes a millorar:', 20, y);
            y += 7;
            let milloresLines = doc.splitTextToSize(avaluacio.aspectesMillora || 'No especificat', 170);
            doc.text(milloresLines, 20, y);
            y += milloresLines.length * 5 + 10;
            
            doc.text('Recomanaci√≥ professional:', 20, y);
            y += 7;
            let recomanacioLines = doc.splitTextToSize('‚Ä¢ ' + (avaluacio.recomanacio || 'No especificada'), 170);
            doc.text(recomanacioLines, 20, y);
            y += recomanacioLines.length * 5 + 10;
            
            doc.text('VALORACI√ì QUALITATIVA GLOBAL:', 20, y);
            y += 7;
            let valoracioLines = doc.splitTextToSize(avaluacio.valoracioGlobal || 'No especificada', 170);
            doc.text(valoracioLines, 20, y);
            
            doc.save(`RA4_${alumne.nom.replace(/\s+/g, '_')}.pdf`);
        }

        window.generarPdfIndividual = generarPdfIndividual;

        // ===========================================
        // GENERAR PDF INDIVIDUAL (BOT√ì)
        // ===========================================
        document.getElementById('generarPdfIndividualBtn').addEventListener('click', function() {
            let index = document.getElementById('selectorAlumne').value;
            if (index === '') {
                alert('Selecciona un alumne');
                return;
            }
            generarPdfIndividual(parseInt(index));
        });

        // ===========================================
        // GENERAR PDF DE TOTS
        // ===========================================
        document.getElementById('pdfTotsBtn').addEventListener('click', function() {
            if (alumnes.length === 0) return;
            for (let i = 0; i < alumnes.length; i++) {
                setTimeout(() => {
                    generarPdfIndividual(i);
                }, i * 500);
            }
        });

        // ===========================================
        // EXPORTAR A EXCEL
        // ===========================================
        document.getElementById('excelBtn').addEventListener('click', function() {
            if (alumnes.length === 0) {
                alert('Primer carrega els JSON');
                return;
            }
            
            let dades = [['Nom', 'Grup', 'Autodiagnosi', 'Full ruta', 'Reflexi√≥', 'Qualitat', 'Nota final']];
            
            alumnes.forEach(a => {
                let index = alumnes.indexOf(a);
                let av = alumnesAvaluats[index] || { autodiagnosi: 'pendent', fullRuta: 'pendent', reflexio: 'pendent', qualitat: 'pendent', notaFinal: 'pendent' };
                
                dades.push([
                    a.nom,
                    a.grup,
                    av.autodiagnosi,
                    av.fullRuta,
                    av.reflexio,
                    av.qualitat,
                    av.notaFinal
                ]);
            });

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(dades);
            XLSX.utils.book_append_sheet(wb, ws, 'RA4_Resultats');
            XLSX.writeFile(wb, 'RA4_notes_grup.xlsx');
        });

        // ===========================================
        // CARREGAR JSON
        // ===========================================
        document.getElementById('carregarJsonBtn').addEventListener('click', function() {
            const files = document.getElementById('jsonFiles').files;
            if (files.length === 0) {
                alert('Selecciona almenys un fitxer');
                return;
            }
            
            alumnes = [];
            alumnesAvaluats = {};
            let pendents = files.length;
            let errors = [];
            
            document.getElementById('statusMessage').style.display = 'block';
            document.getElementById('statusMessage').innerHTML = 'Processant ' + pendents + ' fitxers...';
            document.getElementById('statusMessage').style.background = '#fff3cd';
            
            for (let i = 0; i < files.length; i++) {
                processarJSON(files[i], function(error) {
                    if (error) errors.push(error);
                    
                    pendents--;
                    if (pendents === 0) {
                        if (errors.length > 0) {
                            document.getElementById('statusMessage').innerHTML = '‚ùå Errors: ' + errors.join('<br>');
                            document.getElementById('statusMessage').style.background = '#f8d7da';
                        } else {
                            document.getElementById('statusMessage').innerHTML = '‚úÖ Processats ' + files.length + ' fitxers';
                            document.getElementById('statusMessage').style.background = '#d4edda';
                        }
                        actualitzarTaula();
                    }
                });
            }
        });

        // ===========================================
        // NETEJAR
        // ===========================================
        document.getElementById('netejarBtn').addEventListener('click', function() {
            alumnes = [];
            alumnesAvaluats = {};
            document.getElementById('taulaContainer').style.display = 'none';
            document.getElementById('jsonFiles').value = '';
            document.getElementById('statusMessage').style.display = 'none';
            document.getElementById('selectorAlumne').innerHTML = '<option value="">-- Selecciona un alumne --</option>';
            
            // Amagar panel si estava obert
            document.getElementById('panelRespostes').style.display = 'none';
        });
    </script>
</body>
</html>