<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RA5 ¬∑ Professor ¬∑ Avaluaci√≥ autom√†tica</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js"></script>
    <style>
        /* ESTILS COMPLETS (exactament igual que els RA) */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Arial, sans-serif;
        }
        body {
            background: linear-gradient(135deg, #f5f5f5 0%, #e9ecef 100%);
            padding: 30px;
            color: #212529;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(209,34,43,0.15);
            overflow: hidden;
        }
        .header {
            background: #D1222B;
            padding: 25px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        .header h1 {
            font-size: 2rem;
            margin-bottom: 5px;
        }
        .header .accessibility-icon {
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            color: white;
            border: 2px solid white;
        }
        .content {
            padding: 30px 35px;
        }
        .badge-groc {
            background: #FFC72C;
            color: #1e293b;
            padding: 8px 18px;
            border-radius: 40px;
            font-weight: 700;
            font-size: 1rem;
            display: inline-block;
            margin-bottom: 20px;
            border: 2px solid #D1222B;
        }
        .section-title {
            font-size: 1.8rem;
            color: #D1222B;
            border-left: 8px solid #FFC72C;
            padding-left: 18px;
            margin: 30px 0 20px;
        }
        .btn {
            background: white;
            border: 2px solid #D1222B;
            color: #D1222B;
            padding: 10px 20px;
            border-radius: 40px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin: 5px;
            transition: all 0.2s;
            text-decoration: none;
        }
        .btn:hover, .btn:focus {
            background: #D1222B;
            color: white;
            outline: 3px solid #FFC72C;
        }
        .btn-primary {
            background: #D1222B;
            color: white;
        }
        .btn-primary:hover, .btn-primary:focus {
            background: #b01e25;
            border-color: #b01e25;
        }
        .btn-danger {
            background: #6c757d;
            color: white;
            border: none;
        }
        .btn-success {
            background: #28a745;
            color: white;
            border: none;
        }
        .btn-excel {
            background: #1e88e5;
            color: white;
            border: none;
        }
        .btn-pdf {
            background: #dc3545;
            color: white;
            border: none;
        }
        .btn-dalt {
            background: #FFC72C;
            color: #D1222B;
            border: none;
            font-weight: bold;
        }
        .btn-dalt:hover {
            background: #D1222B;
            color: white;
        }
        .buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 20px 0;
            justify-content: center;
        }
        .import-area {
            background: #f0f7ff;
            border-radius: 20px;
            padding: 20px;
            margin: 20px 0;
            border: 2px solid #D1222B;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 0.9rem;
        }
        th {
            background: #D1222B;
            color: white;
            padding: 10px;
        }
        td {
            border: 1px solid #ffd9d9;
            padding: 8px;
        }
        tr:hover {
            background: #fff3cd;
        }
        .valoracio-box {
            background: #e6f2ff;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            border: 2px solid #D1222B;
        }
        textarea, input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ffd9d9;
            border-radius: 12px;
            margin: 8px 0 15px;
            font-size: 1rem;
        }
        textarea:focus, input:focus, select:focus {
            outline: 3px solid #FFC72C;
            border-color: #D1222B;
        }
        .footer {
            background: #f1f5f9;
            padding: 20px;
            text-align: center;
        }
        hr {
            border: 2px dashed #FFC72C;
            margin: 30px 0;
        }
        .enllac-normativa {
            display: inline-block;
            background: #f0f7ff;
            border: 1px solid #D1222B;
            border-radius: 20px;
            padding: 5px 15px;
            margin: 5px;
            color: #D1222B;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.2s;
        }
        .enllac-normativa:hover {
            background: #D1222B;
            color: white;
        }
        .info-links {
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 1px solid #e9ecef;
        }
        .rubrica-visual {
            background: #f8fafc;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            border: 2px solid #FFC72C;
        }
        .rubrica-visual table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        .rubrica-visual th {
            background: #D1222B;
            color: white;
            padding: 10px;
            font-size: 0.9rem;
        }
        .rubrica-visual td {
            border: 1px solid #ffd9d9;
            padding: 8px;
            font-size: 0.85rem;
        }
        
        /* PANEL DE RESPOSTES DESPLEGABLE */
        .panel-respostes {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 10px 0;
            border: 2px solid #D1222B;
            max-height: 400px;
            overflow-y: auto;
            display: none;
        }
        
        /* BOT√ì FLOTANT PER TORNAR A DALT */
        .btn-flotant {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 99;
            border-radius: 50px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>
    <!-- BOT√ì FLOTANT PER TORNAR A DALT -->
    <button class="btn btn-dalt btn-flotant" id="tornarDaltBtn" title="Tornar a dalt">
        ‚¨ÜÔ∏è Dalt
    </button>

    <div class="container">
        <div class="header">
            <div>
                <h1>‚ö° RA5 ¬∑ Professor ¬∑ Avaluaci√≥ autom√†tica</h1>
                <p>La meva identitat digital professional ¬∑ PLE + Marca personal</p>
            </div>
            <div class="accessibility-icon">‚ôø</div>
        </div>
        <div class="content">
            <div class="badge-groc">üìå Corrector autom√†tic per al RA5</div>

            <!-- ENLLA√áOS D'INTER√àS (conservats del RA5) -->
            <div class="info-links">
                <p><strong>üìö Enlla√ßos d'inter√®s per a la correcci√≥:</strong></p>
                <div>
                    <a href="https://dizquie4-sys.github.io/CURSO-CDD/fp-trs-ipo-i-u5-pdfindex.pdf" target="_blank" class="enllac-normativa">üìñ Llibre: Entorn personal d'aprenentatge (IOC)</a>
                    <a href="https://www.linkedin.com" target="_blank" class="enllac-normativa">LinkedIn</a>
                    <a href="https://www.canva.com" target="_blank" class="enllac-normativa">Canva (per al CV)</a>
                    <a href="https://visualcv.com" target="_blank" class="enllac-normativa">VisualCV</a>
                </div>
            </div>

            <!-- IMPORTADOR JSON -->
            <div class="import-area">
                <h2 style="color:#D1222B;">üì• Importar JSON dels alumnes (RA5)</h2>
                <p>Selecciona els fitxers JSON que han enviat els alumnes.</p>
                <input type="file" id="jsonFiles" multiple accept=".json" style="padding:10px; border:2px dashed #D1222B; width:100%;">
                <div class="buttons">
                    <button class="btn btn-primary" id="carregarJsonBtn">üìÇ Carregar fitxers</button>
                    <button class="btn btn-danger" id="netejarBtn">üóëÔ∏è Netejar tot</button>
                </div>
                <div id="statusMessage" style="margin-top:15px; padding:10px; border-radius:10px; display:none;"></div>
            </div>

            <!-- TAULA DE RESULTATS -->
            <div id="taulaContainer" style="display:none;">
                <h2 class="section-title">üìä Resultats del grup (RA5)</h2>
                <div style="overflow-x: auto;">
                    <table id="resultatsTaula">
                        <thead>
                            <tr>
                                <th>Nom</th>
                                <th>Grup</th>
                                <th>PLE</th>
                                <th>Identitat</th>
                                <th>CV</th>
                                <th>Qualitat</th>
                                <th>Nota final</th>
                                <th>PDF</th>
                            </tr>
                        </thead>
                        <tbody id="taulaBody"></tbody>
                    </table>
                </div>

                <!-- R√öBRICA VISIBLE (PER CONSULTA) -->
                <div class="rubrica-visual">
                    <h3 style="color:#D1222B; margin-bottom:15px;">üìä R√öBRICA D'AVALUACI√ì RA5</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Criteri</th>
                                <th>Pes</th>
                                <th>1 - No assolit</th>
                                <th>2 - En proc√©s</th>
                                <th>3 - Assolit</th>
                                <th>4 - Excel¬∑lent</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>PLE</strong></td>
                                <td>30%</td>
                                <td>No identifica o incomplet</td>
                                <td>Identifica elements b√†sics sense millores</td>
                                <td>PLE complet amb proposta de millora</td>
                                <td>PLE molt complet, ben estructurat i millores innovadores</td>
                            </tr>
                            <tr>
                                <td><strong>Identitat digital</strong></td>
                                <td>30%</td>
                                <td>No analitza o reflexi√≥ superficial</td>
                                <td>Cerca b√†sica sense definir pilars</td>
                                <td>Analitza resultats i defineix 3 pilars</td>
                                <td>An√†lisi profund, pilars coherents i visi√≥ estrat√®gica</td>
                            </tr>
                            <tr>
                                <td><strong>CV digital</strong></td>
                                <td>30%</td>
                                <td>No inclou LinkedIn ni CV</td>
                                <td>LinkedIn o CV poc elaborats</td>
                                <td>LinkedIn actualitzat + CV visual</td>
                                <td>Perfils professionals, integrats amb PLE i full de ruta</td>
                            </tr>
                            <tr>
                                <td><strong>Qualitat formal</strong></td>
                                <td>10%</td>
                                <td>Incomplet o inintel¬∑ligible</td>
                                <td>Conf√∫s o errors significatius</td>
                                <td>Clar i organitzat</td>
                                <td>Professional, ben estructurat</td>
                            </tr>
                        </tbody>
                    </table>
                    <p style="margin-top:10px; font-style:italic; color:#D1222B;">* Els valors autom√†tics s√≥n orientatius. Pots modificar-los manualment.</p>
                </div>

                <!-- SELECCI√ì D'ALUMNE PER VALORAR -->
                <div class="valoracio-box">
                    <h3 style="color:#D1222B;">üìù Avaluaci√≥ individual (RA5)</h3>
                    <select id="selectorAlumne" style="width:100%; padding:10px; margin:10px 0;">
                        <option value="">-- Selecciona un alumne --</option>
                    </select>
                    
                    <!-- BOT√ì PER MOSTRAR/AMAGAR RESPOSTES -->
                    <div style="text-align: center; margin: 10px 0;">
                        <button class="btn btn-primary" id="toggleRespostesBtn">
                            üìã Mostrar/amagar respostes completes
                        </button>
                    </div>
                    
                    <!-- PANEL DE RESPOSTES DESPLEGABLE -->
                    <div id="panelRespostes" class="panel-respostes">
                        <h4 style="color:#D1222B; margin-bottom:10px;">Respostes de l'alumne</h4>
                        <div id="contingutRespostes">
                            Selecciona un alumne i fes clic a "Mostrar respostes".
                        </div>
                    </div>
                    
                    <h4 style="color:#D1222B;">R√∫brica RA5 (punts 1-4)</h4>
                    
                    <label><strong>PLE (30%):</strong></label>
                    <input type="number" id="notaPLE" min="1" max="4" step="1" value="3">
                    
                    <label><strong>Identitat digital (30%):</strong></label>
                    <input type="number" id="notaIdentitat" min="1" max="4" step="1" value="3">
                    
                    <label><strong>CV digital (30%):</strong></label>
                    <input type="number" id="notaCV" min="1" max="4" step="1" value="3">
                    
                    <label><strong>Qualitat formal (10%):</strong></label>
                    <input type="number" id="notaQualitat" min="1" max="4" step="1" value="3">
                    
                    <label><strong>Punts forts observats:</strong></label>
                    <textarea id="puntsForts" rows="3"></textarea>
                    
                    <label><strong>Aspectes a millorar:</strong></label>
                    <textarea id="aspectesMillora" rows="3"></textarea>
                    
                    <label><strong>Recomanaci√≥ professional:</strong></label>
                    <textarea id="recomanacio" rows="2"></textarea>
                    
                    <label><strong>Valoraci√≥ qualitativa global:</strong></label>
                    <textarea id="valoracioGlobal" rows="4"></textarea>
                    
                    <div class="buttons">
                        <button class="btn btn-primary" id="guardarAvaluacioBtn">üíæ Guardar avaluaci√≥</button>
                        <button class="btn btn-pdf" id="generarPdfIndividualBtn">üì• Generar PDF individual</button>
                    </div>
                </div>

                <!-- BOTONS GENERALS -->
                <div class="buttons">
                    <button class="btn btn-excel" id="excelBtn">üì• Exportar a Excel</button>
                    <button class="btn btn-pdf" id="pdfTotsBtn">üì• Generar PDFs de tots</button>
                </div>
            </div>

            <hr>
            <p style="text-align:center; color:#6c757d;">Eina de correcci√≥ per al professorat ¬∑ RA5 ¬∑ Les dades no es guarden al servidor</p>
        </div>
        <div class="footer">Diego Izquierdo ¬∑ FOL ¬∑ IOC ¬∑ Avaluaci√≥ RA5 ‚ôø</div>
    </div>

    <script>
        // ===========================================
        // FUNCIONS PRINCIPALS (el mateix que als altres RA professor)
        // ===========================================
        let alumnes = [];
        let alumnesAvaluats = {};

        function getNivellText(valor) {
            const nivells = ['No assolit', 'En proc√©s', 'Assolit', 'Excel¬∑lent'];
            return nivells[valor - 1] || 'No assolit';
        }

        function calcularNotaFinal(ple, identitat, cv, qualitat) {
            let nota = (ple * 0.3 + identitat * 0.3 + cv * 0.3 + qualitat * 0.1) * 2.5;
            return nota.toFixed(2);
        }

        function generarPuntsFortsAuto(alumne) {
            let punts = [];
            
            if (alumne.ple_fonts && alumne.ple_eines && alumne.ple_xarxes) {
                if (alumne.ple_fonts.length > 30 && alumne.ple_eines.length > 30 && alumne.ple_xarxes.length > 30) {
                    punts.push('RA5: PLE complet amb fonts, eines i xarxes ben definides.');
                }
            }
            
            if (alumne.pilar1 && alumne.pilar2 && alumne.pilar3) {
                punts.push('RA5: Tres pilars de marca personal ben definits.');
            }
            
            if (alumne.linkedin && alumne.cv_digital) {
                punts.push('RA5: Perfil de LinkedIn i CV digital proporcionats.');
            }
            
            if (punts.length === 0) punts.push('Treball correcte en general.');
            return punts.join('\n');
        }

        function generarAspectesMilloraAuto(alumne) {
            let millores = [];
            
            if (!alumne.ple_fonts || alumne.ple_fonts.length < 20) 
                millores.push('RA5: Cal ampliar les fonts d\'informaci√≥ del PLE.');
            if (!alumne.ple_eines || alumne.ple_eines.length < 20) 
                millores.push('RA5: Cal ampliar les eines digitals del PLE.');
            if (!alumne.ple_xarxes || alumne.ple_xarxes.length < 20) 
                millores.push('RA5: Cal ampliar les xarxes de contacte del PLE.');
            
            if (!alumne.pilar1 || !alumne.pilar2 || !alumne.pilar3) 
                millores.push('RA5: Cal definir els tres pilars de la marca personal.');
            
            if (!alumne.linkedin) 
                millores.push('RA5: Cal proporcionar l\'enlla√ß al perfil de LinkedIn.');
            if (!alumne.cv_digital) 
                millores.push('RA5: Cal proporcionar l\'enlla√ß al CV digital.');
            
            if (millores.length === 0) millores.push('Treball complet, felicitats!');
            return millores.join('\n');
        }

        function generarRecomanacioAuto(alumne, nota) {
            if (nota >= 8) {
                return 'Excel¬∑lent treball. Continua desenvolupant la teva marca personal i el teu PLE.';
            } else if (nota >= 6) {
                return 'Bona feina. Revisa els aspectes a millorar per assolir l\'excel¬∑l√®ncia en la teva identitat digital.';
            } else {
                return 'Treball suficient. Es recomana revisar els continguts b√†sics del RA5 i la metodologia PLE.';
            }
        }

        function generarValoracioGlobalAuto(alumne, nota, nom) {
            if (nota >= 8) {
                return `${nom}, el teu treball demostra una comprensi√≥ excel¬∑lent de la identitat digital i la gesti√≥ del PLE. Has dissenyat un entorn d'aprenentatge molt complet, has reflexionat profundament sobre la teva marca personal i has creat un CV digital professional. En conjunt, has fet una molt bona feina. Felicitats!`;
            } else if (nota >= 6) {
                return `${nom}, el teu treball demostra una comprensi√≥ s√≤lida de la identitat digital i la gesti√≥ del PLE. Has identificat correctament els elements principals i has definit una marca personal coherent. Amb una mica m√©s de detall, assolir√†s l'excel¬∑l√®ncia. Bona feina!`;
            } else {
                return `${nom}, el teu treball demostra una comprensi√≥ b√†sica de la identitat digital i la gesti√≥ del PLE. Cal revisar els continguts fonamentals del RA5 i aprofundir en l'an√†lisi de la teva pres√®ncia digital. Amb m√©s dedicaci√≥, podr√†s millorar. √Änims!`;
            }
        }

        function processarJSON(file, callback) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    alumnes.push({
                        nom: data.nom || 'Sense nom',
                        grup: data.grup || 'Sense grup',
                        ple_fonts: data.ple_fonts || '',
                        ple_eines: data.ple_eines || '',
                        ple_xarxes: data.ple_xarxes || '',
                        ple_representacio: data.ple_representacio || '',
                        ple_millores: data.ple_millores || '',
                        cerca_resultats: data.cerca_resultats || '',
                        imatge_actual: data.imatge_actual || '',
                        imatge_desitjada: data.imatge_desitjada || '',
                        pilar1: data.pilar1 || '',
                        pilar2: data.pilar2 || '',
                        pilar3: data.pilar3 || '',
                        linkedin: data.linkedin || '',
                        cv_digital: data.cv_digital || '',
                        cv_descripcio: data.cv_descripcio || '',
                        notaPLE: 'pendent',
                        notaIdentitat: 'pendent',
                        notaCV: 'pendent',
                        notaQualitat: 'pendent',
                        notaFinal: 'pendent',
                        data: data.data || new Date().toISOString()
                    });
                    
                    callback(null);
                } catch (error) {
                    callback('Error: ' + error);
                }
            };
            reader.readAsText(file);
        }

        function getCognom(nomComplet) {
            let parts = nomComplet.trim().split(' ');
            return parts[parts.length - 1];
        }

        function actualitzarTaula() {
            alumnes.sort((a, b) => {
                let cognomA = getCognom(a.nom);
                let cognomB = getCognom(b.nom);
                return cognomA.localeCompare(cognomB, 'ca');
            });

            let tbody = document.getElementById('taulaBody');
            let selector = document.getElementById('selectorAlumne');
            tbody.innerHTML = '';
            selector.innerHTML = '<option value="">-- Selecciona un alumne --</option>';
            
            alumnes.forEach((a, index) => {
                let notaFinal = a.notaFinal === 'pendent' ? 'pendent' : a.notaFinal;
                
                let row = `<tr>
                    <td>${a.nom}</td>
                    <td>${a.grup}</td>
                    <td>${a.notaPLE}</td>
                    <td>${a.notaIdentitat}</td>
                    <td>${a.notaCV}</td>
                    <td>${a.notaQualitat}</td>
                    <td><strong>${notaFinal}</strong></td>
                    <td><button class="btn btn-pdf" onclick="generarPdfIndividual(${index})">üìÑ</button></td>
                </tr>`;
                tbody.innerHTML += row;
                
                selector.innerHTML += `<option value="${index}">${a.nom} (${a.grup})</option>`;
            });
            
            document.getElementById('taulaContainer').style.display = 'block';
        }

        document.getElementById('tornarDaltBtn').addEventListener('click', function() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        document.getElementById('toggleRespostesBtn').addEventListener('click', function() {
            let panel = document.getElementById('panelRespostes');
            let contingut = document.getElementById('contingutRespostes');
            let index = document.getElementById('selectorAlumne').value;
            
            if (index === '') {
                alert('Selecciona un alumne primer');
                return;
            }
            
            let alumne = alumnes[index];
            
            if (panel.style.display === 'none' || panel.style.display === '') {
                let respostesHTML = `
                    <p><strong>PLE:</strong></p>
                    <p><strong>Fonts:</strong> ${alumne.ple_fonts || '(sense resposta)'}</p>
                    <p><strong>Eines:</strong> ${alumne.ple_eines || '(sense resposta)'}</p>
                    <p><strong>Xarxes:</strong> ${alumne.ple_xarxes || '(sense resposta)'}</p>
                    <p><strong>Representaci√≥:</strong> ${alumne.ple_representacio || '(sense enlla√ß)'}</p>
                    <p><strong>Millores:</strong> ${alumne.ple_millores || '(sense resposta)'}</p>
                    <p><strong>Identitat digital:</strong></p>
                    <p><strong>Cerca Google:</strong> ${alumne.cerca_resultats || '(sense resposta)'}</p>
                    <p><strong>Imatge actual:</strong> ${alumne.imatge_actual || '(sense resposta)'}</p>
                    <p><strong>Imatge desitjada:</strong> ${alumne.imatge_desitjada || '(sense resposta)'}</p>
                    <p><strong>Pilars:</strong> ${alumne.pilar1 || ''}, ${alumne.pilar2 || ''}, ${alumne.pilar3 || ''}</p>
                    <p><strong>CV digital:</strong></p>
                    <p><strong>LinkedIn:</strong> ${alumne.linkedin || '(sense enlla√ß)'}</p>
                    <p><strong>CV digital:</strong> ${alumne.cv_digital || '(sense enlla√ß)'}</p>
                    <p><strong>Descripci√≥ CV:</strong> ${alumne.cv_descripcio || '(sense descripci√≥)'}</p>
                `;
                
                contingut.innerHTML = respostesHTML;
                panel.style.display = 'block';
            } else {
                panel.style.display = 'none';
            }
        });

        document.getElementById('selectorAlumne').addEventListener('change', function() {
            let index = this.value;
            if (index === '') {
                document.getElementById('notaPLE').value = '3';
                document.getElementById('notaIdentitat').value = '3';
                document.getElementById('notaCV').value = '3';
                document.getElementById('notaQualitat').value = '3';
                document.getElementById('puntsForts').value = '';
                document.getElementById('aspectesMillora').value = '';
                document.getElementById('recomanacio').value = '';
                document.getElementById('valoracioGlobal').value = '';
                
                document.getElementById('panelRespostes').style.display = 'none';
                return;
            }
            
            let alumne = alumnes[index];
            
            if (alumnesAvaluats[index]) {
                let av = alumnesAvaluats[index];
                document.getElementById('notaPLE').value = av.ple;
                document.getElementById('notaIdentitat').value = av.identitat;
                document.getElementById('notaCV').value = av.cv;
                document.getElementById('notaQualitat').value = av.qualitat;
                document.getElementById('puntsForts').value = av.puntsForts || '';
                document.getElementById('aspectesMillora').value = av.aspectesMillora || '';
                document.getElementById('recomanacio').value = av.recomanacio || '';
                document.getElementById('valoracioGlobal').value = av.valoracioGlobal || '';
            } else {
                document.getElementById('notaPLE').value = '3';
                document.getElementById('notaIdentitat').value = '3';
                document.getElementById('notaCV').value = '3';
                document.getElementById('notaQualitat').value = '3';
                
                let notaTemp = calcularNotaFinal(3, 3, 3, 3);
                document.getElementById('puntsForts').value = generarPuntsFortsAuto(alumne);
                document.getElementById('aspectesMillora').value = generarAspectesMilloraAuto(alumne);
                document.getElementById('recomanacio').value = generarRecomanacioAuto(alumne, notaTemp);
                document.getElementById('valoracioGlobal').value = generarValoracioGlobalAuto(alumne, notaTemp, alumne.nom.split(' ')[0]);
            }
        });

        document.getElementById('guardarAvaluacioBtn').addEventListener('click', function() {
            let index = document.getElementById('selectorAlumne').value;
            if (index === '') {
                alert('Selecciona un alumne');
                return;
            }
            
            let ple = parseInt(document.getElementById('notaPLE').value);
            let identitat = parseInt(document.getElementById('notaIdentitat').value);
            let cv = parseInt(document.getElementById('notaCV').value);
            let qualitat = parseInt(document.getElementById('notaQualitat').value);
            let notaFinal = calcularNotaFinal(ple, identitat, cv, qualitat);
            
            alumnesAvaluats[index] = {
                ple: ple,
                identitat: identitat,
                cv: cv,
                qualitat: qualitat,
                puntsForts: document.getElementById('puntsForts').value,
                aspectesMillora: document.getElementById('aspectesMillora').value,
                recomanacio: document.getElementById('recomanacio').value,
                valoracioGlobal: document.getElementById('valoracioGlobal').value,
                notaFinal: notaFinal
            };
            
            alumnes[index].notaPLE = ple + '/4 - ' + getNivellText(ple);
            alumnes[index].notaIdentitat = identitat + '/4 - ' + getNivellText(identitat);
            alumnes[index].notaCV = cv + '/4 - ' + getNivellText(cv);
            alumnes[index].notaQualitat = qualitat + '/4 - ' + getNivellText(qualitat);
            alumnes[index].notaFinal = notaFinal;
            
            actualitzarTaula();
            alert('Avaluaci√≥ guardada correctament');
        });

        function generarPdfIndividual(index) {
            let alumne = alumnes[index];
            let avaluacio = alumnesAvaluats[index] || {
                ple: 3,
                identitat: 3,
                cv: 3,
                qualitat: 3,
                puntsForts: generarPuntsFortsAuto(alumne),
                aspectesMillora: generarAspectesMilloraAuto(alumne),
                recomanacio: generarRecomanacioAuto(alumne, 7.5),
                valoracioGlobal: generarValoracioGlobalAuto(alumne, 7.5, alumne.nom.split(' ')[0]),
                notaFinal: calcularNotaFinal(3, 3, 3, 3)
            };
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(16);
            doc.setTextColor(0, 0, 0);
            doc.text('INFORME D\'AVALUACI√ì - RA5', 20, 20);
            
            doc.setFontSize(10);
            doc.text('Microactivitat: La meva identitat digital professional', 20, 30);
            doc.text('Professor: Diego Izquierdo Per√°n', 20, 37);
            doc.text('Data: ' + new Date().toLocaleDateString('ca-ES'), 20, 44);
            
            doc.text('DADES DE L\'ESTUDIANT', 20, 59);
            doc.text('Nom: ' + alumne.nom, 20, 66);
            doc.text('Grup: ' + alumne.grup, 20, 73);
            
            doc.text('R√öBRICA D\'AVALUACI√ì', 20, 88);
            doc.text('1. PLE: ' + avaluacio.ple + '/4 - Nivell: ' + getNivellText(avaluacio.ple), 25, 98);
            doc.text('2. Identitat digital: ' + avaluacio.identitat + '/4 - Nivell: ' + getNivellText(avaluacio.identitat), 25, 105);
            doc.text('3. CV digital: ' + avaluacio.cv + '/4 - Nivell: ' + getNivellText(avaluacio.cv), 25, 112);
            doc.text('4. Qualitat formal: ' + avaluacio.qualitat + '/4 - Nivell: ' + getNivellText(avaluacio.qualitat), 25, 119);
            
            doc.text('RESULTATS FINALS', 20, 134);
            doc.text('PUNTUACI√ì TOTAL: ' + (avaluacio.ple + avaluacio.identitat + avaluacio.cv + avaluacio.qualitat) + '/16', 20, 144);
            doc.text('EQUIVAL√àNCIA: ' + avaluacio.notaFinal + '/10', 20, 151);
            
            let nivellGlobal = parseFloat(avaluacio.notaFinal) >= 8 ? 'Excel¬∑lent' : 
                              parseFloat(avaluacio.notaFinal) >= 6 ? 'Assolit' : 'En proc√©s';
            doc.text('NIVELL: ' + nivellGlobal, 20, 158);
            
            doc.text('FEEDBACK PERSONALITZAT', 20, 173);
            let y = 183;
            
            doc.text('Punts forts:', 20, y);
            y += 7;
            let puntsLines = doc.splitTextToSize(avaluacio.puntsForts || 'No especificat', 170);
            doc.text(puntsLines, 20, y);
            y += puntsLines.length * 5 + 10;
            
            doc.text('Aspectes a millorar:', 20, y);
            y += 7;
            let milloresLines = doc.splitTextToSize(avaluacio.aspectesMillora || 'No especificat', 170);
            doc.text(milloresLines, 20, y);
            y += milloresLines.length * 5 + 10;
            
            doc.text('Recomanaci√≥ professional:', 20, y);
            y += 7;
            let recomanacioLines = doc.splitTextToSize('‚Ä¢ ' + (avaluacio.recomanacio || 'No especificada'), 170);
            doc.text(recomanacioLines, 20, y);
            y += recomanacioLines.length * 5 + 10;
            
            doc.text('VALORACI√ì QUALITATIVA GLOBAL:', 20, y);
            y += 7;
            let valoracioLines = doc.splitTextToSize(avaluacio.valoracioGlobal || 'No especificada', 170);
            doc.text(valoracioLines, 20, y);
            
            doc.save(`RA5_${alumne.nom.replace(/\s+/g, '_')}.pdf`);
        }

        window.generarPdfIndividual = generarPdfIndividual;

        document.getElementById('generarPdfIndividualBtn').addEventListener('click', function() {
            let index = document.getElementById('selectorAlumne').value;
            if (index === '') {
                alert('Selecciona un alumne');
                return;
            }
            generarPdfIndividual(parseInt(index));
        });

        document.getElementById('pdfTotsBtn').addEventListener('click', function() {
            if (alumnes.length === 0) return;
            for (let i = 0; i < alumnes.length; i++) {
                setTimeout(() => {
                    generarPdfIndividual(i);
                }, i * 500);
            }
        });

        document.getElementById('excelBtn').addEventListener('click', function() {
            if (alumnes.length === 0) {
                alert('Primer carrega els JSON');
                return;
            }
            
            let dades = [['Nom', 'Grup', 'PLE', 'Identitat', 'CV', 'Qualitat', 'Nota final']];
            
            alumnes.forEach(a => {
                let index = alumnes.indexOf(a);
                let av = alumnesAvaluats[index] || { ple: 'pendent', identitat: 'pendent', cv: 'pendent', qualitat: 'pendent', notaFinal: 'pendent' };
                
                dades.push([
                    a.nom,
                    a.grup,
                    av.ple,
                    av.identitat,
                    av.cv,
                    av.qualitat,
                    av.notaFinal
                ]);
            });

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(dades);
            XLSX.utils.book_append_sheet(wb, ws, 'RA5_Resultats');
            XLSX.writeFile(wb, 'RA5_notes_grup.xlsx');
        });

        document.getElementById('carregarJsonBtn').addEventListener('click', function() {
            const files = document.getElementById('jsonFiles').files;
            if (files.length === 0) {
                alert('Selecciona almenys un fitxer');
                return;
            }
            
            alumnes = [];
            alumnesAvaluats = {};
            let pendents = files.length;
            let errors = [];
            
            document.getElementById('statusMessage').style.display = 'block';
            document.getElementById('statusMessage').innerHTML = 'Processant ' + pendents + ' fitxers...';
            document.getElementById('statusMessage').style.background = '#fff3cd';
            
            for (let i = 0; i < files.length; i++) {
                processarJSON(files[i], function(error) {
                    if (error) errors.push(error);
                    
                    pendents--;
                    if (pendents === 0) {
                        if (errors.length > 0) {
                            document.getElementById('statusMessage').innerHTML = '‚ùå Errors: ' + errors.join('<br>');
                            document.getElementById('statusMessage').style.background = '#f8d7da';
                        } else {
                            document.getElementById('statusMessage').innerHTML = '‚úÖ Processats ' + files.length + ' fitxers';
                            document.getElementById('statusMessage').style.background = '#d4edda';
                        }
                        actualitzarTaula();
                    }
                });
            }
        });

        document.getElementById('netejarBtn').addEventListener('click', function() {
            alumnes = [];
            alumnesAvaluats = {};
            document.getElementById('taulaContainer').style.display = 'none';
            document.getElementById('jsonFiles').value = '';
            document.getElementById('statusMessage').style.display = 'none';
            document.getElementById('selectorAlumne').innerHTML = '<option value="">-- Selecciona un alumne --</option>';
            document.getElementById('panelRespostes').style.display = 'none';
        });
    </script>
</body>
</html>
